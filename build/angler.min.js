/* Copyright 2016 Tobias Schwinger.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
(function(){'use strict';function v(a){var d=new Float32Array(9);a&&(d[0]=d[4]=d[8]=a);return d}function w(a,d,b){for(var f=0;3!==f;++f)for(var c=3*f,e=0;9!==e;e+=3)a[e+f]=d[c]*b[e]+d[c+1]*b[e+1]+d[c+2]*b[e+2];return a}function A(a,d,b,f,c){for(var e=0;3!==e;++e)for(var k=3*e,g=0;9!==g;g+=3){for(var n=0,l=0;3!==l;++l)var r=g+l,u=k+l,n=n+(d[r]*b[u]+f[r]*c[u]);a[g+e]=n}return a};function aa(){this.l=v(1);this.i=v(1);this.j=v(1);this.v=v(1);this.A=v(1);this.B=v();this.w=v();this.m=!0;this.s=v(1);this.u=v(1);this.D=v();this.C=v()};function C(a,d){var b=a.b;if(void 0!==b){var f=a.a.length/(a.c||1);if(0!==f%1)throw Error("sampleData.length is not a multiple of sampleSize");if(!Array.isArray(b)){for(var c=b.start,e=b.step,b=Array(f),k=0;k!==f;++k)b[k]=c+k*e;d.push({a:a.a,c:a.c,b:b});return}if(b.length!==f)throw Error("sampleDomain.length does not match the number of samples");}d.push(a)}function F(a){var d=[];if(Array.isArray(a))for(var b=0,f=a.length;b!==f;++b)C(a[b],d);else C(a,d);return d}
function ba(a,d,b){return function(f){for(var c=0,e=0,k=a.length;e!==k;++e)var g=a[e],n=(f-g.f)*(f<g.f?g.h:g.d),c=c+g.g*Math.exp(-.5*n*n);return d[b]=c}}
function ca(a,d,b){function f(a){a*=e;for(var c=0;c!==e;++c)d[c+b]=k[a+c];return 1!==e?d:d[0]}var c=a.b,e=a.c||1,k=a.a,g=0,n=-0,l=-0,r=0,u=0;return function(a){var b=g,h=c[b],m=c[b-1];a:{b:{c:{d:if(!(a<h)){for(var q=b+2;;){if(void 0===h){if(a<m)break d;g=b=c.length;return f(b-1)}if(b===q)break;m=h;h=c[++b];if(a<h)break b}m=c.length;break c}if(a>=m)break a;else{h=c[1];a<h&&(b=2,m=h);for(q=b-2;;){if(void 0===m)return g=0,f(0);if(b===q)break;h=m;m=c[--b-1];if(a>=m)break b}m=b;b=0}}for(;b<m;)h=b+m>>>
1,a<c[h]?m=h:b=h+1;h=c[b];m=c[b-1];if(void 0===m)return g=0,f(0);if(void 0===h)return g=b=c.length,f(b-1)}g=b;var q=b-2,p=b+1,t=c[q],z=c[p];void 0===t&&(q=b,t=2*m-h);void 0===z&&(p=b,z=2*h-m);var B=.5*(h-m);n=B/(m-t);l=B/(z-h);r=q*e;u=p*e}b*=e;q=b-e;h=(a-m)/(h-m);p=h*h;t=p*h;a=-n*t+2*n*p-n*h;m=(1+n)*t+(-1.5-2*n)*p+(-.5+n)*h+1;h=(-1-l)*t+(1.5+l)*p+.5*h;p=l*t-l*p;for(t=0;t!==e;++t)d[t]=a*k[r+t]+m*k[q+t]+h*k[b+t]+p*k[u+t];return 1!==e?d:d[0]}}
function G(a,d){for(var b=a.length,f=Array(b),c=0,e=0;e!==b;++e){var k=a[e],g=void 0!==k.c?k.c:1,n=d||new Float32Array(g),l=0;void 0!==d&&(l=c,c+=g);g=k.o;f[e]=void 0!==g?ba(g,n,l):ca(k,n,l)}return f}function H(a){a=F(a);for(var d=0,b=0,f=a.length;b!==f;++b)d+=a[b].c||1;var c=new Float32Array(d),e=G(a,c);return 1===e.length?e[0]:function(a){for(var b=0,d=e.length;b!==d;++b)e[b](a);return 1!==c.length?c:c[0]}};var I={b:{start:400,step:25},c:3,a:[0,0,.03,.36,-.02,.6,.58,-.005,1,.3,.1,.6,.1,.4,.4,.2,.86,.64,.47,1,.78,.82,.8,.76,1,.43,.6,.72,.17,.3,.28,.04,.1,.07,.005,.01,.01,0,0]};var J={b:[560,570,580,590,600,610,620,630,640,650,660,700],a:[0,0,.02,.075,.25,.46,.65,.73,.77,.8,.82,.84]},K={b:[400,460,500,515,520,540,550,560,570,580,590,600,685,690,700],a:[.25,.67,.77,.7,.67,.45,.33,.18,.08,.03,0,0,0,0,.02]};function L(a,d,b){return function(f){return a[d](f)*a[b](f)}}
function M(){this.spectrumFilterR=this.spectrumFilterL=this.spectrumDisplay=this.colorSpace=null;var a=new aa;this.j=a;this.encoderL=a.s;this.encoderR=a.u;this.filterOpacity=this.filterBalance=0;this.hueImportance=1;this.separationR=this.separationL=0;this.colorization=1;this.colorFusion=this.hueOverdrive=.2;this.duboisNormalization=this.colorSpaceIsXYZ=!1;this.l=a=Array(12);this.m=new Float32Array(36);v();for(var d=0;3!==d;++d)a[3+d]=L(a,0+d,9),a[6+d]=L(a,0+d,10);a[11]=L(a,9,10)}
M.prototype.i=function(){for(var a=this.l,d=this.spectrumDisplay||H(I),b=0;3!==b;++b)a[0+b]=d[b];a[9]=this.spectrumFilterL||H(J);a[10]=this.spectrumFilterR||H(K);for(var d=this.m,b=this.colorSpace||H(I),f=a.length,c=3*f,e=d||new Float32Array(c),k=0;k!==c;++k)e[k]=0;for(c=401.25;700>c;c+=2.5)for(var k=b(c),g=0;g!==f;++g)for(var n=3*g,l=a[g](c),r=0;3!==r;++r)e[n+r]+=l*k[r];a=d[1];a=1/a;for(b=0;27!==b;++b)d[b]*=a;f=1.4*this.filterBalance;a=Math.pow(.33,this.filterOpacity-1);b=(2+f)*a;f=(2-f)*a;e=this.colorSpaceIsXYZ;
for(g=l=k=c=0;3!==g;++g)var n=d[27+g],r=d[30+g],u=d[33+g],c=c+n*n,k=k+r*r,l=l+u*u;var c=1/Math.sqrt(c),k=1/Math.sqrt(k),g=this.separationL,n=this.separationR,l=.25/l,g=g*Math.abs(g)*l,n=n*Math.abs(n)*l,l=this.hueImportance,r=.125*this.colorization/(a*a),u=.2*this.colorFusion,x=this.hueOverdrive,y=1-x;e&&(l=.99*l+.01,l*=l);for(var a=this.j,h=0;3!==h;++h)for(var m=0;3!==m;++m){var q=3*h+m;a.l[q]=d[0+q];a.i[q]=d[9+q]*b;a.j[q]=d[18+q]*f;var p=d[27+m]*c,t=d[27+h]*c,z=d[30+m]*k,B=d[30+h]*k,D=u,E=u;m==h&&
(e?D=E=1!==m?l:1:(D=t*l+.7*(1-l),E=B*l+.7*(1-l)));p*=b;t*=b;z*=f;B*=f;D-=r*(y*p+x*z)*B;E-=r*(y*z+x*p)*t;a.v[q]=D;a.A[q]=E;p=-d[33+m]*d[33+h];a.B[q]=g*p;a.w[q]=n*p}a.m=this.duboisNormalization;f=a.l;e=a.i;c=a.j;d=a.s;b=a.u;e=A(a.D,A(d,e,a.v,c,a.w),e,A(b,e,a.B,c,a.A),c);c=e[0];k=e[1];g=e[2];n=e[3];l=e[4];r=e[5];u=e[6];x=e[7];y=e[8];h=y*l-r*x;m=r*u-y*n;q=x*n-l*u;p=c*h+k*m+g*q;if(0===p)throw Error("can't invert singular matrix");p=1/p;e[0]=p*h;e[1]=p*(g*x-y*k);e[2]=p*(r*k-g*l);e[3]=p*m;e[4]=p*(y*c-g*
u);e[5]=p*(g*n-r*c);e[6]=p*q;e[7]=p*(k*u-x*c);e[8]=p*(l*c-k*n);w(d,e,w(a.C,d,f));w(b,e,w(a.C,b,f));if(a.m){for(c=e=f=a=0;9!==c;c+=3)a+=d[c]+b[c],f+=d[c+1]+b[c+1],e+=d[c+2]+b[c+2];for(c=0;9!==c;c+=3)d[c]/=a,b[c]/=a,d[c+1]/=f,b[c+1]/=f,d[c+2]/=e,b[c+2]/=e}};for(var da=window,ea={XYZ_CIE31:H([{o:[{g:.362,f:442,h:.0624,d:.0374},{g:1.056,f:599.8,h:.0264,d:.0323},{g:-.065,f:501.1,h:.049,d:.0382}]},{o:[{g:.821,f:568.8,h:.0213,d:.0247},{g:.286,f:530.9,h:.0613,d:.0322}]},{o:[{g:1.217,f:437,h:.0845,d:.0278},{g:.681,f:459,h:.0385,d:.0725}]}]),RGB_Marguier06_A:H(I),RGB_Marguier06_B:H({b:{start:400,step:25},c:3,a:[0,0,0,.17,.05,.55,.23,.13,1,.03,.22,.58,-.15,.42,.22,-.2,.89,.22,.13,.98,.26,.6,.67,.27,1,.2,.23,.72,-.034,.12,.28,-.03,.04,.07,-.01,.01,0,0,0]})},N=
F([{b:[570,572,577,581,585,587,591,594,597,602,604,606,607.5,608.5,613,619,626,629,631,632,645,649,652,658,660,662,663,665,670,677,682,684,688,690,695,698,700],a:[0,0,.02,.02,.13,.06,.08,.01,.04,.01,.02,.06,.15,.89,.18,.12,.04,.12,.03,.02,.01,.03,.01,.01,.017,.01,.01,.015,.01,.014,.008,.014,.006,.007,.02,.006,0]},{b:[432,433,434,434.5,435,435.5,436,443,444,445,446,447,448,449,450,451,452,453,454,465,468,480,486,490,497,500,520,529,535,536,539,540,542,542.5,543,543.2,544,544.5,545.5,547,548,552,552.8,
555,559,560,574,574.5,575,576,577,578,581,583,584,586,590,591,595,599,600,601,602,607,608,610,611,613,617,620,622,624,625,629,630,631,635,650,700],a:[0,0,.01,.025,.025,0,0,0,0,.01,0,0,0,0,.01,.005,.015,0,0,0,0,.035,.125,.122,.075,.04,.008,.01,.028,.04,.18,.3,.83,1,.8,.73,.73,.94,.94,.29,.22,.12,.09,.03,.005,.005,.005,.005,.01,.06,.03,.09,.055,.09,.055,.09,.035,.04,.01,.015,.005,.01,.006,.004,.008,.085,.085,.028,.005,.007,.01,.005,.005,.005,.008,.005,.005,.005,.006]},{b:[400,401,405,406,408,415,430,
432,432.5,433,434,435,436,436.5,437,440,450,470,478,480,486,488,490,494,496,498,500,501,520,535,537,539,540,544,545,546,553,560,580,583,584,585,586,590,592.5,593.5,594.5,595.5,604,609,610,611,612,620],a:[0,0,.02,.01,.002,.001,.055,.065,.08,.3,.62,.8,.5,.11,.09,.1,.13,.09,.06,.06,.15,.15,.12,.06,.05,.05,.014,.014,.007,.01,.01,.02,.07,.07,.04,.03,.002,0,0,0,.003,0,0,0,0,.002,0,0,0,0,.002,0,0,0]}]),O=[],P=0,fa=N.length;P!==fa;++P){var Q=N[P],R=Q.c||1;if(1<R){for(var S=Q.a,T=Array(R),U=S.length/R,V=0;V!==
R;++V)T[V]=new Float32Array(U);for(var W=0;W!==U;++W)for(var X=0;X!==R;++X)T[X][W]=S[W*R+X];for(var Y=0;Y!==R;++Y)O.push({b:Q.b,a:T[Y],c:1})}else O.push(Q)}
da.angler={ColorSpaces:ea,Displays:{LCD:G(O)},Filters3D:{Red:H(J),Cyan:H(K),Magenta:H({b:[400,420,440,460,470,480,490,500,570,580,590,600,610,620,660,700],a:[.43,.42,.38,.17,.08,.026,0,0,0,0,.05,.28,.65,.77,.86,.87]}),Green:H({b:[470,480,490,500,520,525,532,560,570,580,590,600],a:[0,0,.02,.12,.34,.35,.34,.11,.05,.02,0,0]}),Blue:H({b:[400,443,460,470,490,530,535,650,660,670,685,700],a:[.08,.41,.33,.22,.08,0,0,0,0,.01,.03,.12]}),Yellow:H({b:[470,480,490,535,565,590,600,620,650,680,700],a:[0,0,.01,.046,
.028,.1,.11,.1,.145,.094,.32]})},MatrixController:M};var Z=M.prototype;Z.update=Z.i;})();

